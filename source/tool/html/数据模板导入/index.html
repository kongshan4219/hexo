<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Data Mapper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        table {
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
        }

        select,
        input {
            width: 100%;
            box-sizing: border-box;
        }

        button {
            margin: 10px 0;
            padding: 5px 10px;
        }
    </style>
</head>

<body>
    <!-- ... (保持其他HTML部分不变) ... -->

    <script>
        // ... (保持其他JavaScript变量和函数不变) ...

        function updateMappingTable() {
            if (dataFields.length > 0) {
                let html = '<table><tr><th>字段</th>';
                for (let field of templateFields) {
                    html += `<th>${field}</th>`;
                }
                html += '</tr><tr><td>模板字段</td>';
                for (let field of templateFields) {
                    html += `<td>${field}</td>`;
                }
                html += '</tr><tr><td>数据字段</td>';
                for (let field of templateFields) {
                    html += `<td><select id="select_${field}" onchange="adjustColumnWidth(this)">`;
                    html += '<option value="">请选择</option>';
                    for (let dataField of dataFields) {
                        html += `<option value="${dataField}">${dataField}</option>`;
                    }
                    html += '</select></td>';
                }
                html += '</tr><tr><td>固定值</td>';
                for (let field of templateFields) {
                    html += `<td><input type="text" id="input_${field}" oninput="adjustColumnWidth(this)"></td>`;
                }
                html += '</tr></table>';
                document.getElementById('mappingTable').innerHTML = html;
            }
        }

        function adjustColumnWidth(element) {
            const td = element.closest('td');
            const index = td.cellIndex;
            const table = td.closest('table');
            let maxWidth = 0;

            // 计算当前列中最宽的内容
            for (let i = 0; i < table.rows.length; i++) {
                const cell = table.rows[i].cells[index];
                const cellContent = cell.textContent || cell.innerText;
                const cellWidth = getTextWidth(cellContent);
                maxWidth = Math.max(maxWidth, cellWidth);
            }

            // 设置当前列的宽度
            for (let i = 0; i < table.rows.length; i++) {
                table.rows[i].cells[index].style.minWidth = `${maxWidth + 20}px`; // 添加一些额外的空间
            }
        }

        function getTextWidth(text) {
            const canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
            const context = canvas.getContext("2d");
            context.font = "14px sans-serif"; // 根据实际使用的字体进行调整
            const metrics = context.measureText(text);
            return metrics.width;
        }

        // ... (保持其他JavaScript函数不变) ...
    </script>
</body>

</html>
